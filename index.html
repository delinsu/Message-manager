<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SubTrack 2.0 - 自动化版</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    </style>
</head>
<body>

<div class="drawer">
    <input id="settings-drawer" type="checkbox" class="drawer-toggle" />
    
    <div class="drawer-content flex flex-col min-h-screen">
        <!-- 导航栏 -->
        <div class="navbar bg-base-100 shadow-sm px-4 lg:px-8">
            <div class="flex-1 text-xl font-bold tracking-tight flex items-center gap-2">
                <div class="bg-primary p-2 rounded-lg text-white">
                    <i data-lucide="layers" class="w-6 h-6"></i>
                </div>
                SubTrack
                <!-- 这里的状态指示灯很有用 -->
                <div id="sync-status" class="badge badge-ghost badge-sm gap-1 ml-2 opacity-50">
                    <i data-lucide="cloud" class="w-3 h-3"></i> 待命
                </div>
            </div>
            <div class="flex-none">
                <label for="settings-drawer" class="btn btn-ghost btn-circle drawer-button">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </label>
            </div>
        </div>

        <main class="flex-grow p-4 lg:p-8 max-w-6xl mx-auto w-full space-y-8">
            <!-- 汇总仪表盘 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="stats shadow bg-primary text-primary-content">
                    <div class="stat text-center">
                        <div class="stat-title text-primary-content/70 text-xs">月度支出预估</div>
                        <div id="total-monthly" class="stat-value text-2xl">¥ 0.00</div>
                    </div>
                </div>
                <div class="stats shadow bg-white">
                    <div class="stat text-center">
                        <div class="stat-title text-gray-500 text-xs">即将续费 (30天内)</div>
                        <div id="upcoming-count" class="stat-value text-2xl text-warning">0</div>
                    </div>
                </div>
                <div class="stats shadow bg-white">
                    <div class="stat text-center">
                        <div class="stat-title text-gray-500 text-xs text-center">活跃订阅</div>
                        <div id="active-count" class="stat-value text-2xl">0</div>
                    </div>
                </div>
            </div>

            <!-- 操作区 -->
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-bold">我的订阅列表</h2>
                <button class="btn btn-primary btn-sm" onclick="add_modal.showModal()">
                    <i data-lucide="plus" class="w-4 h-4"></i> 添加
                </button>
            </div>

            <!-- 列表区 -->
            <div id="subscription-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-20">
                <!-- 由渲染函数填充 -->
            </div>
        </main>
    </div>

    <!-- 侧边栏：配置页 -->
    <div class="drawer-side z-50">
        <label for="settings-drawer" class="drawer-overlay"></label>
        <div class="menu p-6 w-85 min-h-full bg-base-100 text-base-content border-l border-gray-200">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="settings-2"></i> 同步设置
                </h2>
                <label for="settings-drawer" class="btn btn-sm btn-circle btn-ghost">✕</label>
            </div>
            
            <div class="space-y-4">
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold text-xs uppercase">GitHub Token</span></label>
                    <input type="password" id="gh-token" placeholder="ghp_xxxxxxxx" class="input input-sm input-bordered w-full" />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold text-xs uppercase">仓库 (Username/Repo)</span></label>
                    <input type="text" id="gh-repo" placeholder="octocat/my-subs" class="input input-sm input-bordered w-full" />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold text-xs uppercase">加密密码 (Master Key)</span></label>
                    <input type="password" id="master-key" placeholder="用于 AES 加密的密码" class="input input-sm input-bordered w-full" />
                </div>
                
                <div class="py-4">
                    <button class="btn btn-primary btn-block" onclick="saveConfig()">
                        <i data-lucide="save" class="w-4 h-4"></i> 保存并初始化数据
                    </button>
                </div>

                <div class="alert alert-info text-[11px] leading-relaxed py-2 shadow-none border-none bg-blue-50 text-blue-800">
                    <i data-lucide="info" class="w-4 h-4 mt-1"></i>
                    <div>
                        信息保存在本地 LocalStorage。更改后点击保存将重新尝试从 GitHub 抓取最新数据。
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal 保持不变 -->
<dialog id="add_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">新订阅</h3>
        <div class="space-y-4">
            <input type="text" id="sub-name" placeholder="名称 (如 Netflix)" class="input input-bordered w-full" />
            <div class="flex gap-2">
                <input type="number" id="sub-price" placeholder="价格" class="input input-bordered flex-grow" />
                <select id="sub-currency" class="select select-bordered w-24">
                    <option>CNY</option>
                    <option>USD</option>
                    <option>HKD</option>
                </select>
            </div>
            <input type="date" id="sub-date" class="input input-bordered w-full" />
            <select id="sub-period" class="select select-bordered w-full">
                <option value="month">每月付款 (Monthly)</option>
                <option value="year">每年付款 (Yearly)</option>
            </select>
        </div>
        <div class="modal-action">
            <button class="btn btn-ghost" onclick="add_modal.close()">取消</button>
            <button class="btn btn-primary" onclick="addSubscription()">添加并云同步</button>
        </div>
    </div>
</dialog>

<script>
    let subscriptions = [];
    const statusEl = document.getElementById('sync-status');

    lucide.createIcons();

    // 核心 1：更新 UI 汇总卡片和列表
    function updateUI() {
        const container = document.getElementById('subscription-list');
        container.innerHTML = '';
        let total = 0, upcoming = 0;
        const now = new Date();

        subscriptions.forEach((sub, index) => {
            const billDate = new Date(sub.date);
            const diffDays = Math.ceil((billDate - now) / (1000 * 60 * 60 * 24));
            const isExpired = diffDays < 0;
            if (sub.period === 'year') total += sub.price / 12; else total += parseFloat(sub.price);
            if (diffDays >= 0 && diffDays <= 30) upcoming++;

            const card = document.createElement('div');
            card.className = "card bg-white shadow-sm border border-gray-100 p-4 transition-all hover:shadow-md";
            card.innerHTML = `
                <div class="flex items-center gap-3">
                    <img src="https://logo.clearbit.com/${sub.name.toLowerCase().replace(/\s/g,'')}.com?size=64&fallback=https://ui-avatars.com/api/?name=${sub.name}" class="w-10 h-10 rounded-lg">
                    <div class="flex-grow">
                        <div class="flex justify-between"><h4 class="font-bold text-sm">${sub.name}</h4><span class="text-xs font-bold text-primary">${sub.currency} ${sub.price}</span></div>
                        <div class="text-[10px] text-gray-500">${isExpired ? '已过期' : diffDays + ' 天后扣费'}</div>
                    </div>
                    <button class="btn btn-ghost btn-xs text-error" onclick="deleteSubscription(${index})"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                </div>
            `;
            container.appendChild(card);
        });

        document.getElementById('total-monthly').innerText = `¥ ${total.toFixed(2)}`;
        document.getElementById('upcoming-count').innerText = upcoming;
        document.getElementById('active-count').innerText = subscriptions.length;
        lucide.createIcons();
    }

    // 核心 2：侧边栏保存按钮交互
    function saveConfig() {
        const token = document.getElementById('gh-token').value;
        const repo = document.getElementById('gh-repo').value;
        const key = document.getElementById('master-key').value;

        if(!token || !repo || !key) return alert('请完整填写');

        localStorage.setItem('gh_token', token);
        localStorage.setItem('gh_repo', repo);
        localStorage.setItem('master_key', key);
        
        // 自动关闭并拉取一次数据
        document.getElementById('settings-drawer').checked = false;
        fetchDataFromServer();
    }

    // 核心 3：静默获取数据
    async function fetchDataFromServer() {
        const token = localStorage.getItem('gh_token');
        const repo = localStorage.getItem('gh_repo');
        const key = localStorage.getItem('master_key');

        if (!token || !repo || !key) {
            statusEl.innerHTML = '<i data-lucide="alert-circle" class="w-3 h-3"></i> 未配置';
            statusEl.className = "badge badge-warning badge-sm gap-1 ml-2";
            lucide.createIcons();
            return;
        }

        statusEl.innerHTML = '<span class="loading loading-spinner loading-xs"></span> 同步中...';
        
        try {
            const apiPath = `https://api.github.com/repos/${repo}/contents/data/subscriptions.json.enc`;
            const res = await fetch(apiPath, { headers: { Authorization: `token ${token}` } });
            
            if (res.status === 404) {
                statusEl.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> 云端全新';
            } else {
                const fileData = await res.json();
                const encrypted = atob(fileData.content);
                const bytes = CryptoJS.AES.decrypt(encrypted, key);
                subscriptions = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                statusEl.innerHTML = '<i data-lucide="cloud-check" class="w-3 h-3"></i> 已就绪';
            }
        } catch (e) {
            statusEl.innerHTML = '<i data-lucide="alert-triangle" class="w-3 h-3"></i> 密钥错';
            statusEl.className = "badge badge-error badge-sm gap-1 ml-2";
        }
        updateUI();
        lucide.createIcons();
    }

    // 核心 4：自动保存（Add/Delete 之后触发）
    async function autoSyncToServer() {
        const token = localStorage.getItem('gh_token');
        const repo = localStorage.getItem('gh_repo');
        const key = localStorage.getItem('master_key');

        if (!token) return;

        statusEl.innerHTML = '<span class="loading loading-spinner loading-xs"></span> 云端保存中...';

        const dataStr = JSON.stringify(subscriptions);
        const encrypted = CryptoJS.AES.encrypt(dataStr, key).toString();
        const apiPath = `https://api.github.com/repos/${repo}/contents/data/subscriptions.json.enc`;

        try {
            const getRes = await fetch(apiPath, { headers: { Authorization: `token ${token}` } });
            let sha = (getRes.status === 200) ? (await getRes.json()).sha : null;

            await fetch(apiPath, {
                method: 'PUT',
                headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `Auto-sync ${new Date().getTime()}`,
                    content: btoa(encrypted),
                    sha: sha
                })
            });
            statusEl.innerHTML = '<i data-lucide="cloud-check" class="w-3 h-3"></i> 已同步';
        } catch (e) {
            statusEl.innerHTML = '<i data-lucide="alert-triangle" class="w-3 h-3"></i> 同步失败';
        }
        lucide.createIcons();
    }

    // 交互逻辑：添加
    function addSubscription() {
        const sub = {
            name: document.getElementById('sub-name').value,
            price: document.getElementById('sub-price').value,
            currency: document.getElementById('sub-currency').value,
            date: document.getElementById('sub-date').value,
            period: document.getElementById('sub-period').value
        };
        if (!sub.name || !sub.price || !sub.date) return;
        
        subscriptions.push(sub);
        updateUI();
        add_modal.close();
        autoSyncToServer(); // 自动触发
    }

    // 交互逻辑：删除
    function deleteSubscription(index) {
        if(confirm('确定删除吗？')) {
            subscriptions.splice(index, 1);
            updateUI();
            autoSyncToServer(); // 自动触发
        }
    }

    // 核心 5：页面加载自动触发
    document.addEventListener('DOMContentLoaded', () => {
        // 读取 LocalStorage 到表单
        document.getElementById('gh-token').value = localStorage.getItem('gh_token') || '';
        document.getElementById('gh-repo').value = localStorage.getItem('gh_repo') || '';
        document.getElementById('master-key').value = localStorage.getItem('master_key') || '';
        
        // 自动拉取
        fetchDataFromServer();
    });

</script>
</body>
</html>
