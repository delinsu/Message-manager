<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SubTrack Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card-compact .card-body { padding: 1rem; }
    </style>
</head>
<body>

<div class="drawer">
    <input id="settings-drawer" type="checkbox" class="drawer-toggle" />
    
    <div class="drawer-content flex flex-col min-h-screen">
        <!-- 导航栏 -->
        <div class="navbar bg-base-100 shadow-sm px-4 lg:px-8 sticky top-0 z-40">
            <div class="flex-1 text-xl font-bold tracking-tight flex items-center gap-2">
                <div class="bg-primary p-2 rounded-lg text-white">
                    <i data-lucide="layers" class="w-6 h-6"></i>
                </div>
                SubTrack
                <div id="sync-status" class="badge badge-ghost badge-sm gap-1 ml-2 opacity-50">
                    <i data-lucide="cloud" class="w-3 h-3"></i> 待命
                </div>
            </div>
            <div class="flex-none">
                <label for="settings-drawer" class="btn btn-ghost btn-circle drawer-button">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </label>
            </div>
        </div>

        <main class="flex-grow p-4 lg:p-8 max-w-6xl mx-auto w-full space-y-8">
            <!-- 汇总仪表盘 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="stats shadow bg-primary text-primary-content">
                    <div class="stat text-center">
                        <div class="stat-title text-primary-content/70 text-xs">月度支出预估</div>
                        <div id="total-monthly" class="stat-value text-2xl">¥ 0.00</div>
                    </div>
                </div>
                <div class="stats shadow bg-white">
                    <div class="stat text-center">
                        <div class="stat-title text-gray-500 text-xs">即将续费 (30天内)</div>
                        <div id="upcoming-count" class="stat-value text-2xl text-warning">0</div>
                    </div>
                </div>
                <div class="stats shadow bg-white">
                    <div class="stat text-center">
                        <div class="stat-title text-gray-500 text-xs text-center">活跃订阅</div>
                        <div id="active-count" class="stat-value text-2xl">0</div>
                    </div>
                </div>
            </div>

            <!-- 控制栏：搜索、筛选、排序 -->
            <div class="flex flex-col md:flex-row gap-4 justify-between items-center bg-white p-4 rounded-xl shadow-sm">
                <!-- 搜索 -->
                <div class="relative w-full md:w-64">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
                    </span>
                    <input type="text" id="search-input" placeholder="搜索订阅..." class="input input-bordered input-sm w-full pl-10" oninput="updateUI()">
                </div>

                <!-- Tabs 筛选 -->
                <div class="join">
                    <button class="join-item btn btn-sm btn-active" data-filter="all" onclick="setFilter('all', this)">全部</button>
                    <button class="join-item btn btn-sm" data-filter="upcoming" onclick="setFilter('upcoming', this)">30天内</button>
                    <button class="join-item btn btn-sm" data-filter="year" onclick="setFilter('year', this)">年度</button>
                </div>

                <!-- 排序与添加 -->
                <div class="flex gap-2 w-full md:w-auto">
                    <select id="sort-select" class="select select-bordered select-sm flex-grow md:flex-grow-0" onchange="updateUI()">
                        <option value="date_asc">按扣费日期 (近->远)</option>
                        <option value="price_desc">按价格 (高->低)</option>
                        <option value="name">按名称</option>
                    </select>
                    <button class="btn btn-primary btn-sm" onclick="add_modal.showModal()">
                        <i data-lucide="plus" class="w-4 h-4"></i> 添加
                    </button>
                </div>
            </div>

            <!-- 列表区 -->
            <div id="subscription-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-20">
                <!-- 内容由 updateUI 动态填充 -->
            </div>
            
            <!-- 空状态提示 -->
            <div id="empty-state" class="hidden text-center py-10 text-gray-400">
                <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-20"></i>
                <p class="text-sm">没有找到匹配的订阅</p>
            </div>
        </main>
    </div>

    <!-- 侧边栏：配置页 -->
    <div class="drawer-side z-50">
        <label for="settings-drawer" class="drawer-overlay"></label>
        <div class="menu p-6 w-80 lg:w-96 min-h-full bg-base-100 text-base-content border-l border-gray-200">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="settings-2"></i> 同步设置
                </h2>
                <label for="settings-drawer" class="btn btn-sm btn-circle btn-ghost">✕</label>
            </div>
            
            <div class="space-y-4">
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold text-xs uppercase">GitHub Token</span></label>
                    <input type="password" id="gh-token" placeholder="ghp_xxxxxxxx" class="input input-sm input-bordered w-full" />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold text-xs uppercase">仓库 (Username/Repo)</span></label>
                    <input type="text" id="gh-repo" placeholder="username/repo" class="input input-sm input-bordered w-full" />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold text-xs uppercase">加密密码 (Master Key)</span></label>
                    <input type="password" id="master-key" placeholder="用于 AES 加密的密码" class="input input-sm input-bordered w-full" />
                </div>
                
                <div class="py-4">
                    <button class="btn btn-primary btn-block" onclick="saveConfig()">
                        <i data-lucide="save" class="w-4 h-4"></i> 保存并初始化数据
                    </button>
                </div>

                <div class="alert alert-info text-[11px] leading-relaxed py-2 shadow-sm bg-blue-50 text-blue-800 border border-blue-100">
                    <i data-lucide="info" class="w-4 h-4 mt-1"></i>
                    <div>
                        数据将加密保存在您的 GitHub 仓库中。请妥善保管 Master Key。
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal：添加订阅 -->
<dialog id="add_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">新订阅</h3>
        <div class="space-y-4">
            <input type="text" id="sub-name" placeholder="名称 (如 Spotify)" class="input input-bordered w-full" />
            <div class="flex gap-2">
                <input type="number" id="sub-price" placeholder="价格" class="input input-bordered flex-grow" />
                <select id="sub-currency" class="select select-bordered w-24">
                    <option>CNY</option>
                    <option>USD</option>
                    <option>HKD</option>
                </select>
            </div>
            <div class="form-control">
                <label class="label"><span class="label-text-alt">首次扣费日期 (系统会自动推算下次日期)</span></label>
                <input type="date" id="sub-date" class="input input-bordered w-full" />
            </div>
            <select id="sub-period" class="select select-bordered w-full">
                <option value="month">每月付款 (Monthly)</option>
                <option value="year">每年付款 (Yearly)</option>
            </select>
        </div>
        <div class="modal-action">
            <button class="btn btn-ghost" onclick="add_modal.close()">取消</button>
            <button class="btn btn-primary" onclick="addSubscription()">添加并云同步</button>
        </div>
    </div>
</dialog>

<script>
    let subscriptions = [];
    let currentFilter = 'all'; // all, upcoming, year
    const statusEl = document.getElementById('sync-status');

    lucide.createIcons();

    // 辅助工具：计算实际的下一次扣费日期（同步后端的逻辑）
    function calculateBillDetails(sub) {
        const now = new Date();
        now.setHours(0, 0, 0, 0); // 强制归零时间
        let billDate = new Date(sub.date);
        billDate.setHours(0, 0, 0, 0); // 强制归零时间
        // 自动滚动到未来
        let prevDate = new Date(billDate); 
        while (billDate < now) {
            prevDate = new Date(billDate);
            if (sub.period === 'month') billDate.setMonth(billDate.getMonth() + 1);
            else if (sub.period === 'year') billDate.setFullYear(billDate.getFullYear() + 1);
            else break; 
        }
        // 计算天数差：(目标 - 现在) / 一天毫秒数
        const diffDays = Math.round((billDate - now) / (1000 * 60 * 60 * 24));
        
        // 计算进度条
        const totalCycle = billDate - prevDate;
        const elapsed = now - prevDate;
        let progress = 0;
        if(totalCycle > 0) progress = Math.min(100, Math.max(0, (elapsed / totalCycle) * 100));
        if(billDate.getTime() === new Date(sub.date).setHours(0,0,0,0) && billDate > now) progress = 0;
        return { nextDate: billDate, diffDays, progress };
    }

    // 交互：设置筛选 Tab
    function setFilter(filterType, btn) {
        currentFilter = filterType;
        // 更新按钮样式
        document.querySelectorAll('.join-item').forEach(b => b.classList.remove('btn-active'));
        btn.classList.add('btn-active');
        updateUI();
    }

    // 核心 1：全新的 Update UI (支持搜索、筛选、排序、进度条)
    function updateUI() {
        
        const container = document.getElementById('subscription-list');
        const searchVal = document.getElementById('search-input').value.toLowerCase();
        const sortType = document.getElementById('sort-select').value;
        
        container.innerHTML = '';
        let total = 0, upcomingCount = 0;
        
        const processedSubs = subscriptions.map((sub, index) => {
            const details = calculateBillDetails(sub);
            if (sub.period === 'year') total += sub.price / 12; else total += parseFloat(sub.price);
            if (details.diffDays >= 0 && details.diffDays <= 30) upcomingCount++;
            return { ...sub, ...details, originalIndex: index };
        });
        const filtered = processedSubs.filter(item => {
            if (!item.name.toLowerCase().includes(searchVal)) return false;
            if (currentFilter === 'month') return item.diffDays <= 30; 
            if (currentFilter === 'year') return item.period === 'year';
            if (currentFilter === 'expired') return false; 
            return true; 
        });
        filtered.sort((a, b) => {
            if (sortType === 'date_asc') return a.diffDays - b.diffDays;
            if (sortType === 'price_desc') return b.price - a.price;
            if (sortType === 'name') return a.name.localeCompare(b.name);
            return 0;
        });
        if (filtered.length === 0) {
            document.getElementById('empty-state').classList.remove('hidden');
        } else {
            document.getElementById('empty-state').classList.add('hidden');
            
            filtered.forEach((item) => {
                const card = document.createElement('div');
                card.className = "card bg-white shadow-sm border border-gray-100 p-4 transition-all hover:shadow-md group";
                
                // 颜色状态：今天红，3天内红，7天内黄
                let dateBadge = "bg-gray-100 text-gray-500";
                let progressColor = "bg-primary";
                if (item.diffDays === 0) { dateBadge = "bg-error text-white font-bold animate-pulse"; progressColor = "bg-error"; }
                else if (item.diffDays <= 3) { dateBadge = "bg-error/10 text-error font-bold"; progressColor = "bg-error"; }
                else if (item.diffDays <= 7) { dateBadge = "bg-warning/20 text-warning-content font-bold"; progressColor = "bg-warning"; }
                // 核心：UI 布局优化，解决重叠
                const imgUrl = `https://logo.clearbit.com/${item.name.toLowerCase().replace(/\s/g,'')}.com?size=64`;
                const fallbackUrl = `https://ui-avatars.com/api/?name=${item.name}&background=random&color=fff`;
                card.innerHTML = `
                    <div class="flex items-start gap-3 mb-3">
                        <img src="${imgUrl}" onerror="this.src='${fallbackUrl}'" 
                             class="w-12 h-12 rounded-xl object-contain bg-gray-50 border border-gray-100 shrink-0">
                        <div class="flex-grow min-w-0">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-base truncate" title="${item.name}">${item.name}</h4>
                                <span class="font-bold text-base tracking-tight">${item.currency} ${item.price}</span>
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="badge badge-xs border-none py-2 px-2 ${dateBadge}">
                                    ${item.diffDays === 0 ? '今天扣费' : item.diffDays + ' 天后'}
                                </span>
                                <span class="text-[10px] text-gray-400">/ ${item.period === 'year' ? '年' : '月'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden mb-4">
                        <div class="h-full ${progressColor} opacity-80 rounded-full transition-all duration-500" style="width: ${item.progress}%"></div>
                    </div>
                    
                    <!-- 底部操作栏：彻底分开 -->
                    <div class="flex justify-between items-center text-xs text-gray-400 border-t border-gray-50 pt-3">
                        <span class="font-mono">${item.nextDate.toISOString().slice(0,10)}</span>
                        <div class="flex gap-2">
                             <!-- 这里调用新的 openEditModal -->
                            <button class="btn btn-xs btn-ghost hover:bg-gray-100" onclick="openEditModal(${item.originalIndex})">
                                <i data-lucide="edit-2" class="w-3 h-3"></i> 编辑
                            </button>
                            <button class="btn btn-xs btn-ghost text-error hover:bg-error/10" onclick="deleteSubscription(${item.originalIndex})">
                                <i data-lucide="trash-2" class="w-3 h-3"></i> 删除
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        document.getElementById('total-monthly').innerText = `¥ ${total.toFixed(2)}`;
        document.getElementById('upcoming-count').innerText = upcomingCount;
        document.getElementById('active-count').innerText = subscriptions.length;
        lucide.createIcons();
    }

    // --- 以下为保持不变的后端交互逻辑 ---

    function saveConfig() {
        const token = document.getElementById('gh-token').value;
        const repo = document.getElementById('gh-repo').value;
        const key = document.getElementById('master-key').value;

        if(!token || !repo || !key) return alert('请完整填写配置');

        localStorage.setItem('gh_token', token);
        localStorage.setItem('gh_repo', repo);
        localStorage.setItem('master_key', key);
        
        document.getElementById('settings-drawer').checked = false;
        fetchDataFromServer();
    }

    async function fetchDataFromServer() {
        const token = localStorage.getItem('gh_token');
        const repo = localStorage.getItem('gh_repo');
        const key = localStorage.getItem('master_key');

        if (!token || !repo || !key) {
            statusEl.innerHTML = '<i data-lucide="alert-circle" class="w-3 h-3"></i> 未配置';
            statusEl.className = "badge badge-warning badge-sm gap-1 ml-2";
            lucide.createIcons();
            return;
        }

        statusEl.innerHTML = '<span class="loading loading-spinner loading-xs"></span> 同步中';
        
        try {
            const apiPath = `https://api.github.com/repos/${repo}/contents/data/subscriptions.json.enc`;
            // 添加时间戳防止缓存
            const res = await fetch(`${apiPath}?t=${new Date().getTime()}`, { headers: { Authorization: `token ${token}` } });
            
            if (res.status === 404) {
                statusEl.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> 云端全新';
            } else {
                const fileData = await res.json();
                const encrypted = atob(fileData.content.replace(/\n/g, ''));
                const bytes = CryptoJS.AES.decrypt(encrypted, key);
                const decryptedStr = bytes.toString(CryptoJS.enc.Utf8);
                
                if(!decryptedStr) throw new Error('Decryption failed');
                
                subscriptions = JSON.parse(decryptedStr);
                statusEl.innerHTML = '<i data-lucide="cloud-check" class="w-3 h-3"></i> 已就绪';
            }
        } catch (e) {
            console.error(e);
            statusEl.innerHTML = '<i data-lucide="lock" class="w-3 h-3"></i> 解密/网络失败';
            statusEl.className = "badge badge-error badge-sm gap-1 ml-2";
        }
        updateUI(); // 拿到数据后刷新UI
        lucide.createIcons();
    }

    async function autoSyncToServer() {
        const token = localStorage.getItem('gh_token');
        const repo = localStorage.getItem('gh_repo');
        const key = localStorage.getItem('master_key');
        if (!token) return;

        statusEl.innerHTML = '<span class="loading loading-spinner loading-xs"></span> 保存中';

        const dataStr = JSON.stringify(subscriptions);
        const encrypted = CryptoJS.AES.encrypt(dataStr, key).toString();
        const apiPath = `https://api.github.com/repos/${repo}/contents/data/subscriptions.json.enc`;

        try {
            const getRes = await fetch(apiPath, { headers: { Authorization: `token ${token}` } });
            let sha = (getRes.status === 200) ? (await getRes.json()).sha : null;

            await fetch(apiPath, {
                method: 'PUT',
                headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `Sync ${new Date().toISOString().split('T')[0]}`,
                    content: btoa(encrypted),
                    sha: sha
                })
            });
            statusEl.innerHTML = '<i data-lucide="cloud-check" class="w-3 h-3"></i> 已同步';
        } catch (e) {
            statusEl.innerHTML = '<i data-lucide="alert-triangle" class="w-3 h-3"></i> 同步失败';
        }
        lucide.createIcons();
    }

    // 打开新增窗口
    function openAddModal() {
        document.getElementById('edit-index').value = "-1";
        document.getElementById('modal-title').innerText = "新建订阅";
        document.getElementById('sub-name').value = "";
        document.getElementById('sub-price').value = "";
        document.getElementById('sub-date').valueAsDate = new Date();
        sub_modal.showModal();
    }
    // 打开编辑窗口
    function openEditModal(index) {
        const sub = subscriptions[index];
        document.getElementById('edit-index').value = index;
        document.getElementById('modal-title').innerText = "编辑订阅";
        
        document.getElementById('sub-name').value = sub.name;
        document.getElementById('sub-price').value = sub.price;
        document.getElementById('sub-currency').value = sub.currency || 'CNY';
        document.getElementById('sub-date').value = sub.date;
        document.getElementById('sub-period').value = sub.period;
        
        sub_modal.showModal();
    }
    // 保存逻辑（合并了新增和修改）
    function saveSubscription() {
        const index = parseInt(document.getElementById('edit-index').value);
        const sub = {
            name: document.getElementById('sub-name').value,
            price: document.getElementById('sub-price').value,
            currency: document.getElementById('sub-currency').value,
            date: document.getElementById('sub-date').value,
            period: document.getElementById('sub-period').value
        };
        if (!sub.name || !sub.price || !sub.date) return alert("请填写完整信息");
        if (index === -1) {
            subscriptions.push(sub); // 新增
        } else {
            subscriptions[index] = sub; // 修改
        }
        updateUI();
        sub_modal.close();
        autoSyncToServer();
    }

    function deleteSubscription(index) {
        if(confirm('确定删除此订阅吗？')) {
            subscriptions.splice(index, 1);
            updateUI();
            autoSyncToServer(); 
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('gh-token').value = localStorage.getItem('gh_token') || '';
        document.getElementById('gh-repo').value = localStorage.getItem('gh_repo') || '';
        document.getElementById('master-key').value = localStorage.getItem('master_key') || '';
        fetchDataFromServer();
    });

</script>
</body>
</html>
