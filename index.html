<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SubTrack - è®¢é˜…éšç§ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script type="importmap">
        {
            "imports": {
                "octokit": "https://esm.sh/@octokit/core"
            }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="app" class="min-h-screen flex flex-col md:flex-row" v-cloak>
        <!-- ä¾§è¾¹æ ï¼šé…ç½®é¢æ¿ -->
        <aside class="w-full md:w-80 bg-white border-r p-6 space-y-6">
            <h1 class="text-xl font-bold text-indigo-600 flex items-center">
                <span class="mr-2">ğŸ”</span> SubTrack 
            </h1>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">GitHub Token</label>
                    <input v-model="config.token" type="password" class="w-full border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ghp_xxxxxxxx">
                </div>
                <div>
                    <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">ä»“åº“è·¯å¾„ (Owner/Repo)</label>
                    <input v-model="config.repo" type="text" class="w-full border rounded px-3 py-2 text-sm" placeholder="username/my-subs">
                </div>
                <div>
                    <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">ä¸»åŠ å¯†å¯†é’¥ (Master Key)</label>
                    <input v-model="config.masterKey" type="password" class="w-full border rounded px-3 py-2 text-sm" placeholder="ç”¨äºåŠ å¯†JSONæ•°æ®">
                </div>
                <button @click="saveConfig" class="w-full bg-slate-800 text-white py-2 rounded text-sm hover:bg-slate-700 transition">ä¿å­˜é…ç½®åˆ°æœ¬åœ°</button>
            </div>

            <hr>

            <div class="flex flex-col space-y-2">
                <button @click="loadData" :disabled="loading" class="w-full bg-indigo-600 text-white py-2 rounded font-medium disabled:opacity-50">
                    {{ loading ? 'åŒæ­¥ä¸­...' : 'ä» GitHub æ‹‰å–å¹¶è§£å¯†' }}
                </button>
                <button @click="uploadData" :disabled="loading || items.length === 0" class="w-full border border-indigo-600 text-indigo-600 py-2 rounded font-medium hover:bg-indigo-50">
                    åŠ å¯†å¹¶åŒæ­¥è‡³ GitHub
                </button>
            </div>
        </aside>

        <!-- ä¸»ç•Œé¢ï¼šè®¢é˜…åˆ—è¡¨ -->
        <main class="flex-1 p-8">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">æˆ‘çš„è®¢é˜…</h2>
                    <button @click="showAddForm = !showAddForm" class="bg-green-500 text-white px-4 py-2 rounded-lg shadow hover:bg-green-600 transition">
                        + æ·»åŠ è®¢é˜…
                    </button>
                </div>

                <!-- æ·»åŠ è¡¨å• -->
                <div v-if="showAddForm" class="bg-white p-6 rounded-xl shadow-sm border mb-8 animate-slide-down">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input v-model="newSub.name" type="text" placeholder="æœåŠ¡åç§° (ä¾‹: Netflix)" class="border rounded p-2 text-sm">
                        <input v-model="newSub.price" type="number" placeholder="é‡‘é¢" class="border rounded p-2 text-sm">
                        <select v-model="newSub.currency" class="border rounded p-2 text-sm">
                            <option value="CNY">CNY (ï¿¥)</option>
                            <option value="USD">USD ($)</option>
                            <option value="HKD">HKD ($)</option>
                        </select>
                        <input v-model="newSub.nextDate" type="date" class="border rounded p-2 text-sm">
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button @click="showAddForm = false" class="px-4 py-2 text-slate-500">å–æ¶ˆ</button>
                        <button @click="addSubscription" class="bg-indigo-600 text-white px-6 py-2 rounded-lg">ç¡®è®¤æ·»åŠ </button>
                    </div>
                </div>

                <!-- åˆ—è¡¨å±•ç¤º -->
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b">
                            <tr>
                                <th class="px-6 py-3 text-xs font-semibold uppercase text-slate-500">æœåŠ¡</th>
                                <th class="px-6 py-3 text-xs font-semibold uppercase text-slate-500">è´¹ç”¨</th>
                                <th class="px-6 py-3 text-xs font-semibold uppercase text-slate-500">ä¸‹æ¬¡è®¡è´¹</th>
                                <th class="px-6 py-3 text-xs font-semibold uppercase text-slate-500">çŠ¶æ€</th>
                                <th class="px-6 py-3 text-xs font-semibold uppercase text-slate-500">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            <tr v-for="(item, index) in items" :key="index" class="hover:bg-slate-50 transition">
                                <td class="px-6 py-4 font-medium">{{ item.name }}</td>
                                <td class="px-6 py-4">{{ item.price }} {{ item.currency }}</td>
                                <td class="px-6 py-4 text-sm">{{ item.nextDate }}</td>
                                <td class="px-6 py-4">
                                    <span :class="getDaysClass(item.nextDate)" class="text-xs px-2 py-1 rounded-full font-bold">
                                        è¿˜æœ‰ {{ calculateDays(item.nextDate) }} å¤©
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <button @click="removeItem(index)" class="text-red-400 hover:text-red-600">åˆ é™¤</button>
                                </td>
                            </tr>
                            <tr v-if="items.length === 0">
                                <td colspan="5" class="px-6 py-10 text-center text-slate-400">æš‚æ— æ•°æ®ï¼Œè¯·æ‹‰å–æˆ–æ‰‹åŠ¨æ·»åŠ </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { createApp, ref, onMounted } from 'https://unpkg.com/vue@3/dist/vue.global.js';
        import { Octokit } from "octokit";

        createApp({
            setup() {
                const items = ref([]);
                const loading = ref(false);
                const showAddForm = ref(false);
                const config = ref({
                    token: '',
                    repo: '',
                    masterKey: ''
                });
                const newSub = ref({ name: '', price: '', currency: 'CNY', nextDate: '' });
                const currentSha = ref(''); // ç”¨äºè®°å½• GitHub æ–‡ä»¶çš„ SHA

                onMounted(() => {
                    const saved = localStorage.getItem('sub_manager_config');
                    if (saved) config.value = JSON.parse(saved);
                });

                const saveConfig = () => {
                    localStorage.setItem('sub_manager_config', JSON.stringify(config.value));
                    alert('é…ç½®å·²æœ¬åœ°ä¿å­˜');
                };

                // ä» GitHub æ‹‰å–å¹¶è§£å¯†
                const loadData = async () => {
                    if (!config.value.token || !config.value.repo || !config.value.masterKey) return alert('è¯·å…ˆå®Œå–„é…ç½®');
                    loading.value = true;
                    try {
                        const [owner, repo] = config.value.repo.split('/');
                        const octokit = new Octokit({ auth: config.value.token });
                        
                        const { data } = await octokit.request('GET /repos/{owner}/{repo}/contents/{path}', {
                            owner, repo, path: 'data/subscriptions.json.enc'
                        });
                        
                        currentSha.value = data.sha;
                        const encryptedText = atob(data.content);
                        const bytes = CryptoJS.AES.decrypt(encryptedText, config.value.masterKey);
                        const decryptedData = bytes.toString(CryptoJS.enc.Utf8);
                        
                        items.value = JSON.parse(decryptedData);
                    } catch (e) {
                        console.error(e);
                        alert('è¯»å–å¤±è´¥ï¼šè¯·æ£€æŸ¥ Tokenã€è·¯å¾„åŠ MasterKey æ˜¯å¦åŒ¹é…');
                    } finally {
                        loading.value = false;
                    }
                };

                // åŠ å¯†å¹¶ä¸Šä¼ åˆ° GitHub
                const uploadData = async () => {
                    loading.value = true;
                    try {
                        const [owner, repo] = config.value.repo.split('/');
                        const octokit = new Octokit({ auth: config.value.token });
                        
                        const jsonStr = JSON.stringify(items.value);
                        const encrypted = CryptoJS.AES.encrypt(jsonStr, config.value.masterKey).toString();

                        await octokit.request('PUT /repos/{owner}/{repo}/contents/{path}', {
                            owner, repo,
                            path: 'data/subscriptions.json.enc',
                            message: 'Update subs from Web UI',
                            content: btoa(encrypted),
                            sha: currentSha.value || undefined
                        });
                        alert('åŒæ­¥æˆåŠŸï¼');
                    } catch (e) {
                        alert('åŒæ­¥å¤±è´¥ï¼š' + e.message);
                    } finally {
                        loading.value = false;
                    }
                };

                const addSubscription = () => {
                    if (!newSub.value.name || !newSub.value.nextDate) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                    items.value.push({ ...newSub.value });
                    newSub.value = { name: '', price: '', currency: 'CNY', nextDate: '' };
                    showAddForm.value = false;
                };

                const removeItem = (index) => {
                    if (confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) items.value.splice(index, 1);
                };

                // å·¥å…·å‡½æ•°
                const calculateDays = (dateStr) => {
                    const diff = new Date(dateStr) - new Date();
                    return Math.ceil(diff / (1000 * 60 * 60 * 24));
                };

                const getDaysClass = (dateStr) => {
                    const days = calculateDays(dateStr);
                    if (days <= 3) return 'bg-red-100 text-red-600';
                    if (days <= 7) return 'bg-orange-100 text-orange-600';
                    return 'bg-green-100 text-green-600';
                };

                return {
                    config, items, loading, showAddForm, newSub,
                    saveConfig, loadData, uploadData, addSubscription, removeItem,
                    calculateDays, getDaysClass
                };
            }
        }).mount('#app');
    </script>

    <style>
        [v-cloak] { display: none; }
        @keyframes slide-down {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-down { animation: slide-down 0.3s ease-out; }
    </style>
</body>
</html>
