<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SubTrack Pro | è®¢é˜…ç®¡ç†</title>
    <!-- Tailwind CSS & Google Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .sub-card:hover { transform: translateY(-2px); transition: all 0.2s; }
    </style>
</head>
<body class="text-slate-900 min-h-screen">

<div class="max-w-2xl mx-auto px-6 py-8">
    <!-- Header -->
    <header class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-violet-600">
                SubTrack Pro
            </h1>
            <p class="text-slate-500 text-sm mt-1">ä½ çš„è®¢é˜…å¼€æ”¯ç®¡å®¶</p>
        </div>
        <button onclick="toggleSettings()" class="p-2 hover:bg-white rounded-full transition shadow-sm border border-slate-200">
            <i data-lucide="settings" class="w-6 h-6 text-slate-600"></i>
        </button>
    </header>

    <!-- Stats Dashboard -->
    <div class="grid grid-cols-2 gap-4 mb-8">
        <div class="glass-card p-6 rounded-3xl border border-white shadow-sm">
            <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">æœˆåº¦æ”¯å‡º (é¢„ä¼°)</p>
            <div class="flex items-baseline gap-1">
                <span class="text-2xl font-bold text-indigo-600">Â¥</span>
                <span id="monthly-total" class="text-3xl font-black">0.00</span>
            </div>
        </div>
        <div class="glass-card p-6 rounded-3xl border border-white shadow-sm">
            <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">è®¢é˜…æ€»æ•°</p>
            <div class="flex items-baseline gap-1">
                <span id="sub-count" class="text-3xl font-black text-slate-800">0</span>
                <span class="text-slate-400 font-medium">ä¸ªé¡¹ç›®</span>
            </div>
        </div>
    </div>

    <!-- Main List -->
    <div id="sub-list" class="space-y-4 mb-10">
        <!-- åŠ¨æ€æ³¨å…¥åˆ—è¡¨ -->
    </div>

    <!-- Bottom Add Form (Sticky on Mobile) -->
    <div class="fixed bottom-6 left-0 right-0 px-6 max-w-2xl mx-auto">
        <div class="bg-slate-900/90 backdrop-blur-md text-white p-2 rounded-2xl shadow-2xl border border-slate-700">
            <div class="grid grid-cols-6 gap-2">
                <input id="name" type="text" placeholder="æœåŠ¡å" class="col-span-2 bg-transparent p-3 text-sm focus:outline-none placeholder:text-slate-500">
                <input id="price" type="number" placeholder="é‡‘é¢" class="bg-transparent p-3 text-sm focus:outline-none placeholder:text-slate-500 border-l border-slate-700">
                <select id="period" class="bg-transparent text-sm focus:outline-none cursor-pointer border-l border-slate-700">
                    <option value="month">/æœˆ</option>
                    <option value="year">/å¹´</option>
                </select>
                <div class="col-span-2 flex items-center pr-2">
                    <input id="date" type="date" class="hidden" onchange="addSubscription()">
                    <button onclick="document.getElementById('date').showPicker()" class="w-full bg-indigo-500 hover:bg-indigo-600 py-2 rounded-xl flex justify-center items-center transition">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Panel (Side Sheet) -->
<div id="settings-panel" class="fixed inset-y-0 right-0 w-80 bg-white/95 backdrop-blur-lg shadow-2xl p-8 transform translate-x-full transition-transform duration-300 ease-in-out border-l border-slate-200 z-50 overflow-y-auto">
    <div class="flex justify-between items-center mb-8">
        <h2 class="text-xl font-bold">åŒæ­¥è®¾ç½®</h2>
        <button onclick="toggleSettings()"><i data-lucide="x" class="w-6 h-6 text-slate-400"></i></button>
    </div>
    
    <div class="space-y-6">
        <div>
            <label class="block text-xs font-black text-slate-400 mb-2 uppercase tracking-widest">GitHub Token (PAT)</label>
            <input id="gh-token" type="password" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ghp_xxxx">
        </div>
        <div>
            <label class="block text-xs font-black text-slate-400 mb-2 uppercase tracking-widest">ä»“åº“è·¯å¾„</label>
            <input id="gh-repo" type="text" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" placeholder="username/repo-name">
        </div>
        <div>
            <label class="block text-xs font-black text-slate-400 mb-2 uppercase tracking-widest">ä¸»åŠ å¯†å¯†é’¥ (Master Key)</label>
            <input id="master-key" type="password" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none">
        </div>

        <div class="pt-6 border-t border-slate-100 space-y-3">
            <button onclick="saveToGithub()" id="save-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-2 shadow-lg shadow-emerald-200 transition">
                <i data-lucide="upload-cloud" class="w-5 h-5"></i> åŠ å¯†å¹¶ä¿å­˜
            </button>
            <button onclick="loadFromGithub()" class="w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-600 font-bold py-4 rounded-2xl flex items-center justify-center gap-2 transition">
                <i data-lucide="download-cloud" class="w-5 h-5"></i> ä»ä»“åº“æ‹‰å–
            </button>
        </div>
    </div>

    <div class="mt-12 p-4 bg-amber-50 rounded-2xl border border-amber-100">
        <p class="text-xs text-amber-700 leading-relaxed italic">
            ğŸ’¡ èµ„æ·±æé†’ï¼šä¿®æ”¹åè¯·åŠ¡å¿…ç‚¹å‡»â€œåŠ å¯†å¹¶ä¿å­˜â€ï¼Œå¦åˆ™äº‘ç«¯çš„è„šæœ¬ä¸ä¼šæ›´æ–°æé†’åˆ—è¡¨ã€‚
        </p>
    </div>
</div>

<script>
    let subs = [];
    const storageKeys = ['gh-token', 'gh-repo', 'master-key'];

    // åˆå§‹åŒ–é¡µé¢
    window.onload = () => {
        storageKeys.forEach(k => {
            document.getElementById(k).value = localStorage.getItem(k) || '';
        });
        loadFromGithub();
        lucide.createIcons();
    };

    function toggleSettings() {
        const panel = document.getElementById('settings-panel');
        const isOpen = !panel.classList.contains('translate-x-full');
        panel.classList.toggle('translate-x-full');
        if (isOpen) {
            storageKeys.forEach(k => localStorage.setItem(k, document.getElementById(k).value));
        }
    }

    function addSubscription() {
        const nameInput = document.getElementById('name');
        const priceInput = document.getElementById('price');
        const dateInput = document.getElementById('date');
        const periodInput = document.getElementById('period');

        if (!nameInput.value || !priceInput.value || !dateInput.value) {
            alert("è¯·å®Œæ•´å¡«å†™è¡¨å•ï¼");
            return;
        }

        const sub = {
            id: Date.now(),
            name: nameInput.value,
            price: parseFloat(priceInput.value),
            currency: 'CNY',
            date: dateInput.value,
            period: periodInput.value
        };

        subs.push(sub);
        render();
        
        // é‡ç½®è¡¨å•
        nameInput.value = '';
        priceInput.value = '';
    }

    function deleteSub(id) {
        if(confirm("ç¡®å®šè¦åˆ é™¤è¿™é¡¹è®¢é˜…å—ï¼Ÿ")) {
            subs = subs.filter(s => s.id !== id);
            render();
        }
    }

    function updateStats() {
        let monthly = 0;
        subs.forEach(s => {
            monthly += s.period === 'year' ? s.price / 12 : s.price;
        });
        document.getElementById('monthly-total').innerText = monthly.toFixed(2);
        document.getElementById('sub-count').innerText = subs.length;
    }

    function render() {
        const list = document.getElementById('sub-list');
        if (subs.length === 0) {
            list.innerHTML = `
                <div class="text-center py-20">
                    <div class="text-slate-300 mb-4 flex justify-center"><i data-lucide="box" class="w-12 h-12"></i></div>
                    <p class="text-slate-400">ç›®å‰è¿˜æ²¡æœ‰è®¢é˜…é¡¹ç›®ï¼Œå¼€å§‹æ·»åŠ å§</p>
                </div>`;
        } else {
            list.innerHTML = subs.map(s => `
                <div class="sub-card glass-card p-5 rounded-3xl flex justify-between items-center border border-white shadow-sm transition-all">
                    <div class="flex items-center gap-4">
                        <img src="https://logo.clearbit.com/${s.name.toLowerCase().replace(/\s/g,'')}.com?size=128" 
                             onerror="this.src='https://ui-avatars.com/api/?name=${s.name}&background=6366f1&color=fff'" 
                             class="w-12 h-12 rounded-2xl object-cover shadow-sm">
                        <div>
                            <div class="font-bold text-slate-800">${s.name}</div>
                            <div class="text-xs font-medium text-slate-400 uppercase tracking-tighter">ä¸‹æ¬¡: ${s.date}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-5">
                        <div class="text-right">
                            <div class="font-black text-indigo-600 leading-none">Â¥ ${s.price}</div>
                            <div class="text-[10px] text-slate-400 font-bold uppercase">/ ${s.period === 'month' ? 'æœˆ' : 'å¹´'}</div>
                        </div>
                        <button onclick="deleteSub(${s.id})" class="text-slate-300 hover:text-red-400 transition">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        updateStats();
        lucide.createIcons();
    }

    // åç«¯åŒæ­¥é€»è¾‘ (Crypto + GitHub API) ä¿æŒä¸å˜ï¼Œä½†å¢åŠ  UI åé¦ˆ
    async function loadFromGithub() {
        const token = document.getElementById('gh-token').value;
        const repo = document.getElementById('gh-repo').value;
        const key = document.getElementById('master-key').value;
        if (!token || !repo || !key) return;

        try {
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/data/subscriptions.json.enc`, {
                headers: { 'Authorization': `token ${token}` }
            });
            if (res.ok) {
                const data = await res.json();
                const encrypted = atob(data.content);
                const bytes = CryptoJS.AES.decrypt(encrypted, key);
                const decryptedText = bytes.toString(CryptoJS.enc.Utf8);
                subs = JSON.parse(decryptedText);
                render();
            }
        } catch (e) {
            console.error("åŠ è½½å¤±è´¥", e);
        }
    }

    async function saveToGithub() {
        const btn = document.getElementById('save-btn');
        const token = document.getElementById('gh-token').value;
        const repo = document.getElementById('gh-repo').value;
        const key = document.getElementById('master-key').value;

        if (!token || !repo || !key) return alert("é…ç½®ä¿¡æ¯ä¸å®Œæ•´ï¼");

        btn.innerText = "åŠ å¯†å¹¶åŒæ­¥ä¸­...";
        btn.disabled = true;

        try {
            const jsonStr = JSON.stringify(subs);
            const encrypted = CryptoJS.AES.encrypt(jsonStr, key).toString();
            const base64Content = btoa(encrypted);

            let sha = "";
            const getFile = await fetch(`https://api.github.com/repos/${repo}/contents/data/subscriptions.json.enc`, {
                headers: { 'Authorization': `token ${token}` }
            });
            if (getFile.ok) {
                const fileData = await getFile.json();
                sha = fileData.sha;
            }

            const res = await fetch(`https://api.github.com/repos/${repo}/contents/data/subscriptions.json.enc`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: "Update Subs (Pro UI)",
                    content: base64Content,
                    sha: sha
                })
            });

            if (res.ok) alert("âœ… åŒæ­¥æˆåŠŸï¼");
            else alert("âŒ åŒæ­¥å¤±è´¥ï¼Œæ£€æŸ¥ Token æƒé™ã€‚");
        } catch (e) {
            alert("âŒ å‘ç”Ÿé”™è¯¯: " + e.message);
        } finally {
            btn.innerHTML = `<i data-lucide="upload-cloud" class="w-5 h-5"></i> åŠ å¯†å¹¶ä¿å­˜`;
            btn.disabled = false;
            lucide.createIcons();
        }
    }
</script>

</body>
</html>
